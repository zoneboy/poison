<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Football Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      window.process = { env: { NODE_ENV: 'production' } };
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              neon: { 400: '#4ade80', 500: '#22c55e', 900: '#14532d' }
            },
            animation: { 'spin-slow': 'spin 3s linear infinite' }
          }
        }
      }
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "clsx": "https://esm.sh/clsx@2.1.0",
        "lucide-react": "https://esm.sh/lucide-react@0.368.0"
      }
    }
    </script>
    <style>
      body { 
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        color: rgb(255, 255, 255);
        background: linear-gradient(to bottom, transparent, rgb(0, 0, 0)) rgb(10, 10, 10);
        min-height: 100vh;
      }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-black text-slate-200">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { clsx } from 'clsx';
        import { 
            Trash2, Plus, Database, ShieldCheck, Pencil, X, Save, 
            Loader2, Calculator, AlertTriangle, Terminal, Home as HomeIcon 
        } from 'lucide-react';

        // --- API CLIENT ---
        const api = async (action, payload = {}) => {
            try {
                // Direct path to Netlify Function to avoid redirect issues
                const res = await fetch('/.netlify/functions/api', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload })
                });
                
                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    // Start of robust error handling
                    const text = await res.text();
                    console.error("Fatal Server Error (Non-JSON):", text);
                    
                    // Try to extract title from HTML error
                    let errorMsg = "Server connection failed.";
                    const titleMatch = text.match(/<title>(.*?)<\/title>/i);
                    if (titleMatch) errorMsg += ` (${titleMatch[1]})`;
                    
                    // Detect common Netlify timeouts
                    if (res.status === 502) errorMsg = "Server Timeout (502). The database might be sleeping.";
                    if (res.status === 500) errorMsg = "Internal Server Error (500). Check Function Logs.";
                    
                    throw new Error(errorMsg);
                }

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Server Error');
                return data;
            } catch (e) {
                console.error("API Call Failed:", e);
                throw e;
            }
        };

        // --- COMPONENTS ---
        function StatCard({ label, value, sub, color }) {
            return React.createElement('div', { className: "bg-slate-900 border border-slate-800 p-6 rounded-xl flex flex-col items-center justify-center text-center" },
                React.createElement('span', { className: "text-sm font-semibold text-slate-500 uppercase mb-1" }, label),
                React.createElement('span', { className: clsx("text-4xl font-black mb-2", color) }, value),
                React.createElement('span', { className: "text-xs text-slate-600 font-mono bg-slate-950 px-2 py-1 rounded" }, sub)
            );
        }

        function HomePage() {
            const [leaguesList, setLeaguesList] = useState([]);
            const [teamsList, setTeamsList] = useState([]);
            const [selectedLeague, setSelectedLeague] = useState("");
            const [selectedHome, setSelectedHome] = useState("");
            const [selectedAway, setSelectedAway] = useState("");
            const [loading, setLoading] = useState(false);
            const [prediction, setPrediction] = useState(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                setLoading(true);
                // First ping health to wake up DB and check connection
                api('health')
                    .then(() => api('getLeagues'))
                    .then(setLeaguesList)
                    .catch(err => {
                        console.error("Startup Error:", err);
                        setError(err.message);
                    })
                    .finally(() => setLoading(false));
            }, []);

            useEffect(() => {
                if (selectedLeague) {
                    setLoading(true);
                    api('getTeams', { leagueId: parseInt(selectedLeague) })
                        .then(setTeamsList)
                        .catch(setError)
                        .finally(() => setLoading(false));
                    setSelectedHome("");
                    setSelectedAway("");
                    setPrediction(null);
                }
            }, [selectedLeague]);

            const handleCalculate = async () => {
                if (!selectedLeague || !selectedHome || !selectedAway) return;
                if (selectedHome === selectedAway) { alert("Home and Away teams cannot be the same."); return; }

                setLoading(true);
                setError(null);
                try {
                    const result = await api('predict', {
                        leagueId: parseInt(selectedLeague),
                        homeTeamId: parseInt(selectedHome),
                        awayTeamId: parseInt(selectedAway)
                    });
                    setPrediction(result);
                } catch (e) {
                    setError("Failed to calculate prediction.");
                } finally {
                    setLoading(false);
                }
            };

            const maxProb = prediction ? Math.max(...prediction.matrix.flat().map(c => c.prob)) : 0;

            if (error) {
                return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-[50vh] space-y-6 text-center px-4" },
                    React.createElement('div', { className: "bg-red-500/10 p-4 rounded-full" }, React.createElement(AlertTriangle, { className: "w-12 h-12 text-red-500" })),
                    React.createElement('h2', { className: "text-2xl font-bold text-white" }, "Connection Error"),
                    React.createElement('p', { className: "text-red-300 max-w-md font-mono text-sm bg-black/50 p-3 rounded border border-red-500/30" }, error),
                    React.createElement('button', { onClick: () => window.location.reload(), className: "bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded transition-colors" }, "Retry Connection"),
                    React.createElement('div', { className: "text-xs text-slate-500 bg-slate-900 p-4 rounded text-left font-mono mt-4" }, 
                        "Troubleshooting: 1. Check Netlify Logs. 2. Ensure DATABASE_URL is correct. 3. Check if DB is sleeping."
                    )
                );
            }

            return React.createElement('div', { className: "space-y-12 py-10" },
                React.createElement('div', { className: "text-center space-y-4" },
                    React.createElement('h1', { className: "text-4xl md:text-6xl font-black text-white tracking-tighter" }, "MATCH ", React.createElement('span', { className: "text-neon-400" }, "PREDICTOR")),
                    React.createElement('p', { className: "text-slate-400 max-w-lg mx-auto" }, "Select a league and two teams to generate a probability matrix using Poisson distribution analysis.")
                ),
                React.createElement('div', { className: "grid md:grid-cols-4 gap-4 p-6 bg-slate-900/50 border border-slate-800 rounded-2xl shadow-2xl" },
                    React.createElement('div', { className: "space-y-2" },
                        React.createElement('label', { className: "text-xs font-semibold text-slate-500 uppercase" }, "League"),
                        React.createElement('select', { className: "w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-neon-500", value: selectedLeague, onChange: (e) => setSelectedLeague(e.target.value) },
                            React.createElement('option', { value: "" }, "Select League..."),
                            leaguesList.map(l => React.createElement('option', { key: l.id, value: l.id }, l.name))
                        )
                    ),
                    React.createElement('div', { className: "space-y-2" },
                        React.createElement('label', { className: "text-xs font-semibold text-slate-500 uppercase" }, "Home Team"),
                        React.createElement('select', { className: "w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-neon-500 disabled:opacity-50", value: selectedHome, onChange: (e) => setSelectedHome(e.target.value), disabled: !selectedLeague || loading },
                            React.createElement('option', { value: "" }, "Select Team..."),
                            teamsList.map(t => React.createElement('option', { key: t.id, value: t.id }, t.name))
                        )
                    ),
                    React.createElement('div', { className: "space-y-2" },
                        React.createElement('label', { className: "text-xs font-semibold text-slate-500 uppercase" }, "Away Team"),
                        React.createElement('select', { className: "w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-neon-500 disabled:opacity-50", value: selectedAway, onChange: (e) => setSelectedAway(e.target.value), disabled: !selectedLeague || loading },
                            React.createElement('option', { value: "" }, "Select Team..."),
                            teamsList.map(t => React.createElement('option', { key: t.id, value: t.id }, t.name))
                        )
                    ),
                    React.createElement('div', { className: "flex items-end" },
                        React.createElement('button', { onClick: handleCalculate, disabled: loading || !selectedHome || !selectedAway, className: "w-full bg-neon-500 hover:bg-neon-400 text-slate-950 font-bold py-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" },
                            loading ? React.createElement(Loader2, { className: "animate-spin w-5 h-5" }) : React.createElement(Calculator, { className: "w-5 h-5" }), "CALCULATE"
                        )
                    )
                ),
                prediction && React.createElement('div', { className: "animate-in fade-in slide-in-from-bottom-8 duration-500 space-y-8" },
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
                        React.createElement(StatCard, { label: "Home Win", value: (prediction.homeWinProb * 100).toFixed(1) + "%", sub: `xG: ${prediction.homeExpGoals.toFixed(2)}`, color: "text-neon-400" }),
                        React.createElement(StatCard, { label: "Draw", value: (prediction.drawProb * 100).toFixed(1) + "%", sub: "Neutral Outcome", color: "text-slate-200" }),
                        React.createElement(StatCard, { label: "Away Win", value: (prediction.awayWinProb * 100).toFixed(1) + "%", sub: `xG: ${prediction.awayExpGoals.toFixed(2)}`, color: "text-red-400" })
                    ),
                    React.createElement('div', { className: "overflow-x-auto" },
                        React.createElement('div', { className: "min-w-[600px] bg-slate-900 border border-slate-800 rounded-xl p-6" },
                            React.createElement('h3', { className: "text-lg font-bold text-white mb-4" }, "Scoreline Probability Matrix (%)"),
                            React.createElement('div', { className: "grid grid-cols-[auto_repeat(6,1fr)] gap-1" },
                                React.createElement('div', { className: "flex items-center justify-center font-bold text-slate-500 text-xs p-2" }, "H \\ A"),
                                [0,1,2,3,4,5].map(g => React.createElement('div', { key: `head-${g}`, className: "flex items-center justify-center font-bold text-slate-400 bg-slate-950/50 p-2 rounded" }, g)),
                                prediction.matrix.map((row, hIdx) => React.createElement(React.Fragment, { key: `row-${hIdx}` },
                                    React.createElement('div', { className: "flex items-center justify-center font-bold text-slate-400 bg-slate-950/50 p-2 rounded" }, hIdx),
                                    row.map((cell, aIdx) => React.createElement('div', { key: `${hIdx}-${aIdx}`, className: clsx("flex flex-col items-center justify-center p-3 rounded transition-all", cell.prob === maxProb ? "bg-neon-500 text-slate-950 font-bold scale-105 z-10" : "bg-slate-950 hover:bg-slate-800 text-slate-300") },
                                        React.createElement('span', { className: "text-sm" }, (cell.prob * 100).toFixed(1) + "%")
                                    ))
                                ))
                            )
                        )
                    )
                )
            );
        }

        function AdminPage() {
            const [pin, setPin] = useState("");
            const [authorized, setAuthorized] = useState(false);
            const [activeTab, setActiveTab] = useState('leagues');
            const [leaguesList, setLeaguesList] = useState([]);
            const [teamsList, setTeamsList] = useState([]);
            
            const [editingLeagueId, setEditingLeagueId] = useState(null);
            const [leagueForm, setLeagueForm] = useState({ name: '', avgHome: 1.5, avgAway: 1.2 });
            const [editingTeamId, setEditingTeamId] = useState(null);
            const [teamForm, setTeamForm] = useState({ league_id: '', name: '', home_goals_for: 0, home_goals_against: 0, home_games_played: 0, away_goals_for: 0, away_goals_against: 0, away_games_played: 0 });

            async function verifyPin(p) {
                // In a real app, verify this on server. For now, matching previous logic.
                return p === '1234'; 
            }

            const handleAuth = async () => {
                if (await verifyPin(pin)) {
                    setAuthorized(true);
                    refreshData();
                } else {
                    alert("Invalid PIN. Try '1234'");
                }
            };

            const refreshData = async () => {
                try {
                    const l = await api('getLeagues');
                    setLeaguesList(l);
                    if (l.length > 0 && !teamForm.league_id) setTeamForm(prev => ({ ...prev, league_id: l[0].id.toString() }));
                } catch (e) { console.error(e); alert("Failed to load data"); }
            };

            useEffect(() => {
                if (authorized && teamForm.league_id) {
                    api('getTeams', { leagueId: parseInt(teamForm.league_id) }).then(setTeamsList).catch(console.error);
                }
            }, [authorized, teamForm.league_id]);

            const submitLeague = async () => {
                const action = editingLeagueId ? 'updateLeague' : 'createLeague';
                await api(action, { id: editingLeagueId, ...leagueForm });
                setEditingLeagueId(null);
                setLeagueForm({ name: '', avgHome: 1.5, avgAway: 1.2 });
                refreshData();
            };

            const submitTeam = async () => {
                const action = editingTeamId ? 'updateTeam' : 'createTeam';
                await api(action, { id: editingTeamId, ...teamForm });
                setEditingTeamId(null);
                setTeamForm(prev => ({ ...prev, name: '', home_goals_for: 0, home_goals_against: 0, home_games_played: 0, away_goals_for: 0, away_goals_against: 0, away_games_played: 0 }));
                api('getTeams', { leagueId: parseInt(teamForm.league_id) }).then(setTeamsList);
            };

            const handleDeleteTeam = async (id) => {
                if(confirm('Delete team?')) {
                    await api('deleteTeam', { teamId: id });
                    api('getTeams', { leagueId: parseInt(teamForm.league_id) }).then(setTeamsList);
                }
            };

            if (!authorized) {
                return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-[60vh] gap-4" },
                    React.createElement(ShieldCheck, { className: "w-16 h-16 text-slate-700" }),
                    React.createElement('h2', { className: "text-2xl font-bold" }, "Admin Access"),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('input', { type: "password", placeholder: "PIN", className: "bg-slate-900 border border-slate-800 rounded px-4 py-2 text-white", value: pin, onChange: (e) => setPin(e.target.value) }),
                        React.createElement('button', { onClick: handleAuth, className: "bg-neon-500 text-black font-bold px-4 py-2 rounded" }, "Access")
                    )
                );
            }

            return React.createElement('div', { className: "space-y-8" },
                React.createElement('div', { className: "flex items-center justify-between border-b border-slate-800 pb-4" },
                    React.createElement('h1', { className: "text-3xl font-bold flex items-center gap-2" }, React.createElement(Database, { className: "text-neon-500" }), "Database Management"),
                    React.createElement('div', { className: "flex bg-slate-900 p-1 rounded-lg" },
                        React.createElement('button', { onClick: () => setActiveTab('leagues'), className: `px-4 py-2 rounded text-sm font-medium ${activeTab === 'leagues' ? 'bg-slate-800 text-white' : 'text-slate-500'}` }, "Leagues"),
                        React.createElement('button', { onClick: () => setActiveTab('teams'), className: `px-4 py-2 rounded text-sm font-medium ${activeTab === 'teams' ? 'bg-slate-800 text-white' : 'text-slate-500'}` }, "Teams")
                    )
                ),
                activeTab === 'leagues' ? React.createElement('div', { className: "grid md:grid-cols-2 gap-8" },
                    React.createElement('div', { className: "bg-slate-900 border border-slate-800 p-6 rounded-xl space-y-4" },
                        React.createElement('h3', { className: "text-xl font-bold text-white mb-4" }, editingLeagueId ? 'Edit League' : 'Add League'),
                        React.createElement('input', { placeholder: "Name", className: "w-full bg-slate-950 border border-slate-700 p-3 rounded text-white", value: leagueForm.name, onChange: (e) => setLeagueForm({...leagueForm, name: e.target.value}) }),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                            React.createElement('input', { type: "number", step: "0.1", className: "bg-slate-950 border border-slate-700 p-3 rounded text-white", value: leagueForm.avgHome, onChange: (e) => setLeagueForm({...leagueForm, avgHome: parseFloat(e.target.value)}) }),
                            React.createElement('input', { type: "number", step: "0.1", className: "bg-slate-950 border border-slate-700 p-3 rounded text-white", value: leagueForm.avgAway, onChange: (e) => setLeagueForm({...leagueForm, avgAway: parseFloat(e.target.value)}) })
                        ),
                        React.createElement('button', { onClick: submitLeague, className: "w-full bg-neon-500 text-black font-bold py-3 rounded" }, editingLeagueId ? 'Update' : 'Create')
                    ),
                    React.createElement('div', { className: "bg-slate-900 border border-slate-800 rounded-xl overflow-hidden" },
                        React.createElement('table', { className: "w-full text-left" },
                            React.createElement('thead', { className: "bg-slate-950 text-slate-500 text-xs uppercase" }, React.createElement('tr', null, React.createElement('th', { className: "p-4" }, "Name"), React.createElement('th', { className: "p-4 text-right" }, "Edit"))),
                            React.createElement('tbody', { className: "divide-y divide-slate-800" }, leaguesList.map(l => 
                                React.createElement('tr', { key: l.id }, React.createElement('td', { className: "p-4" }, l.name), React.createElement('td', { className: "p-4 text-right" }, 
                                    React.createElement('button', { onClick: () => { setLeagueForm({name: l.name, avgHome: l.avg_home_goals, avgAway: l.avg_away_goals}); setEditingLeagueId(l.id); }, className: "text-neon-500" }, React.createElement(Pencil, { className: "w-4 h-4" }))
                                ))
                            ))
                        )
                    )
                ) : React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-8" },
                    React.createElement('div', { className: "lg:col-span-1 bg-slate-900 border border-slate-800 p-6 rounded-xl space-y-4" },
                        React.createElement('select', { className: "w-full bg-slate-950 border border-slate-700 p-3 rounded text-white", value: teamForm.league_id, onChange: (e) => setTeamForm({...teamForm, league_id: e.target.value}) }, leaguesList.map(l => React.createElement('option', { key: l.id, value: l.id }, l.name))),
                        React.createElement('input', { placeholder: "Team Name", className: "w-full bg-slate-950 border border-slate-700 p-3 rounded text-white", value: teamForm.name, onChange: (e) => setTeamForm({...teamForm, name: e.target.value}) }),
                        React.createElement('button', { onClick: submitTeam, className: "w-full bg-neon-500 text-black font-bold py-3 rounded" }, editingTeamId ? 'Update' : 'Add Team')
                    ),
                    React.createElement('div', { className: "lg:col-span-2 bg-slate-900 border border-slate-800 rounded-xl overflow-hidden" },
                        React.createElement('table', { className: "w-full text-left" },
                            React.createElement('thead', { className: "bg-slate-950 text-slate-500 text-xs uppercase" }, React.createElement('tr', null, React.createElement('th', { className: "p-4" }, "Team"), React.createElement('th', { className: "p-4 text-right" }, "Actions"))),
                            React.createElement('tbody', { className: "divide-y divide-slate-800" }, teamsList.map(t => 
                                React.createElement('tr', { key: t.id }, React.createElement('td', { className: "p-4" }, t.name), React.createElement('td', { className: "p-4 text-right" }, 
                                    React.createElement('button', { onClick: () => handleDeleteTeam(t.id), className: "text-red-500" }, React.createElement(Trash2, { className: "w-4 h-4" }))
                                ))
                            ))
                        )
                    )
                )
            );
        }

        function App() {
            const [path, setPath] = useState(window.location.pathname);
            useEffect(() => {
                const onPopState = () => setPath(window.location.pathname);
                window.addEventListener('popstate', onPopState);
                return () => window.removeEventListener('popstate', onPopState);
            }, []);
            const navigate = (newPath) => {
                window.history.pushState({}, '', newPath);
                setPath(newPath);
            };
            const PageComponent = path === '/admin' ? AdminPage : HomePage;

            return React.createElement(React.Fragment, null,
                React.createElement('nav', { className: "border-b border-slate-800 bg-slate-950/50 backdrop-blur-md sticky top-0 z-50" },
                    React.createElement('div', { className: "max-w-6xl mx-auto px-6 h-16 flex items-center justify-between" },
                        React.createElement('a', { href: "/", onClick: (e) => { e.preventDefault(); navigate('/'); }, className: "text-xl font-bold tracking-tight text-white flex items-center gap-2" },
                            React.createElement('div', { className: "w-3 h-3 bg-neon-400 rounded-full shadow-[0_0_10px_#4ade80]" }), "NEON", React.createElement('span', { className: "text-slate-500" }, "PREDICT")
                        ),
                        React.createElement('div', { className: "flex gap-6 text-sm font-medium" },
                            React.createElement('a', { href: "/", onClick: (e) => { e.preventDefault(); navigate('/'); }, className: clsx("transition-colors", path === '/' ? "text-neon-400" : "hover:text-neon-400") }, "Calculator"),
                            React.createElement('a', { href: "/admin", onClick: (e) => { e.preventDefault(); navigate('/admin'); }, className: clsx("transition-colors", path === '/admin' ? "text-neon-400" : "hover:text-neon-400") }, "Admin")
                        )
                    )
                ),
                React.createElement('main', { className: "max-w-6xl mx-auto p-6" }, React.createElement(PageComponent))
            );
        }

        const rootEl = document.getElementById('root');
        if (rootEl) createRoot(rootEl).render(React.createElement(App));
    </script>
</body>
</html>
